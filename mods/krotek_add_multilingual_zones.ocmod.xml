<modification>
  <name>Add Multilingual Countries / Zones</name>
  <code>krotek_multilingual_zones</code>
  <version>2.1.0</version>
  <author>Krotek</author>
  <link>http://thekrotek.com</link>

  <!-- Add to admin settings -->
  <file path="admin/model/setting/setting.php">
    <operation>
      <search><![CDATA[class ModelSettingSetting extends Model {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      public function checkNames($table) {
        $query = $this->db->query("SHOW FIELDS FROM `".DB_PREFIX.$table."` WHERE Field = 'name'");
        if (strtolower($query->row['Type']) != 'varchar(2550)') {
          $this->db->query("ALTER TABLE `".DB_PREFIX.$table."` CHANGE name name VARCHAR(2550) NOT NULL");
        }

        $query = $this->db->query("SELECT ".$table."_id, name FROM `".DB_PREFIX.$table."`");

        if ($query->num_rows) {
          $this->load->model('localisation/language');
          $languages = $this->model_localisation_language->getLanguages();

          foreach ($query->rows as $row) {
            if (strpos($row['name'], '###') === false) {
              $newnames = array();
              if (strpos($row['name'], '::') !== false) {
                $oldnames = explode('::', $row['name']);
              } else {
                $oldnames = array();
              }

              foreach ($languages as $language) {
                if ($oldnames) {
                  $newnames[] = $oldnames[$language['language_id'] - 1]."###".$language['language_id'];
                } else {
                  $newnames[] = $row['name']."###".$language['language_id'];
                }
              }

              $this->db->query("UPDATE `".DB_PREFIX.$table."` SET name = '".$this->db->escape(implode('::', $newnames))."' WHERE ".$table."_id = '".(int)$row[$table.'_id']."'");
            }
          }

          $this->cache->delete($table);
        }
      }

      public function getItemName($table, $id) {
        $query = $this->db->query("SELECT name FROM `".DB_PREFIX.$table."` WHERE ".$table."_id = '".(int)$id."'");
        $names = array();
        if (strpos($query->row['name'], '::') !== false) {
          $query->row['name'] = explode('::', $query->row['name']);
          foreach ($query->row['name'] as $name) {
            $name = explode('###', $name);
            $names[$name[1]] = $name[0];
          }
        } else {
          $this->load->model('localisation/language');
          $languages = $this->model_localisation_language->getLanguages();
          foreach ($languages as $language) {
            $names[$language['language_id']] = $query->row['name'];
          }
        }
        return $names;
      }

      public function updateItemName($table, $id, $names) {
        $newnames = array();
        foreach ($names as $language => $name) {
          $newnames[] = $name."###".$language;
        }
        $this->db->query("UPDATE `".DB_PREFIX.$table."` SET name = '".$this->db->escape(implode('::', $newnames))."' WHERE ".$table."_id = '".(int)$id."'");
        $this->cache->delete($table);
      }

      public function getOrderLanguage($order_id) {
        $query = $this->db->query("SELECT language_id FROM `".DB_PREFIX."order` WHERE order_id = '".(int)$order_id."'");
        return $query->row['language_id'];
      }
      ]]></add>
    </operation>
  </file>

  <file path="admin/controller/setting/setting.php">
    <operation>
      <search><![CDATA[class ControllerSettingSetting extends Controller {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      public function updateItemName() {
        $json = array();

        $id = $this->request->post['id'];
        $table = $this->request->post['table'];
        $language = $this->request->post['language'];
        $name = rawurldecode($this->request->post['name']);

        $this->language->load('localisation/'.$table);

        if ($name) {
          if ($name && ((utf8_strlen($name) < 2) || (utf8_strlen($name) > 128))) {
            $json['error']['name'] = $this->language->get('error_name');
          } else {
            $this->load->model('setting/setting');
            $names = $this->model_setting_setting->getItemName($table, $id);
            $names[$language] = $name;
            $this->model_setting_setting->updateItemName($table, $id, $names);
          }
        } else {
          $json['error']['name'] = $this->language->get('error_name');
        }
        $this->response->setOutput(json_encode($json));
      }
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to countries -->
  <file path="admin/model/localisation/country.php">
    <operation>
      <search><![CDATA[function addCountry($data) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      if ($data['name'] && is_array($data['name'])) {
        $newnames = array();
        foreach ($data['name'] as $language => $name) {
          $newnames[] = $name."###".$language;
        }
        $data['name'] = $this->db->escape(implode('::', $newnames));
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function editCountry($country_id, $data) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      if ($data['name'] && is_array($data['name'])) {
        $newnames = array();
        foreach ($data['name'] as $language => $name) {
          $newnames[] = $name."###".$language;
        }
        $data['name'] = $this->db->escape(implode('::', $newnames));
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $query->rows;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $this->load->model('setting/setting');

      foreach ($query->rows as $key => $row) {
        $country = $this->model_setting_setting->getItemName('country', $row['country_id']);
        $query->rows[$key]['name'] = $country[$languages[$this->language->get('code')]['language_id']];
        $tmp[] = $query->rows[$key]['name'];
      }

      array_multisort($tmp, $query->rows);
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $country_data;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $this->load->model('setting/setting');

      foreach ($country_data as $key => $row) {
        $country = $this->model_setting_setting->getItemName('country', $row['country_id']);
        $country_data[$key]['name'] = $country[$languages[$this->language->get('code')]['language_id']];
        $tmp[] = $country_data[$key]['name'];
      }

      array_multisort($tmp, $country_data);
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$sort_data = array(]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $implode = array();

      if (!empty($data['filter_name'])) {
        $implode[] = "name LIKE '%".$this->db->escape($data['filter_name'])."%'";
      }

      if (!empty($data['filter_iso_code_2'])) {
        $implode[] = "iso_code_2 LIKE '%".$this->db->escape($data['filter_iso_code_2'])."%'";
      }

      if (!empty($data['filter_iso_code_3'])) {
        $implode[] = "iso_code_3 LIKE '%".$this->db->escape($data['filter_iso_code_3'])."%'";
      }

      if ($implode) {
        $sql .= " WHERE ".implode(" AND ", $implode);
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $query->row['total'];]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $sql = "SELECT COUNT(*) AS total FROM ".DB_PREFIX."country";
      $implode = array();

      if (!empty($this->request->get['filter_name'])) {
        $implode[] = "name LIKE '%".$this->db->escape($this->request->get['filter_name'])."%'";
      }

      if (!empty($this->request->get['filter_iso_code_2'])) {
        $implode[] = "iso_code_2 LIKE '%".$this->db->escape($this->request->get['filter_iso_code_2'])."%'";
      }

      if (!empty($this->request->get['filter_iso_code_3'])) {
        $implode[] = "iso_code_3 LIKE '%".$this->db->escape($this->request->get['filter_iso_code_3'])."%'";
      }

      if ($implode) {
        $sql .= " WHERE ".implode(" AND ", $implode);
      }

      $query = $this->db->query($sql);
      ]]></add>
    </operation>
  </file>

  <file path="admin/controller/localisation/country.php">
    <operation>
      <search><![CDATA[$data['heading_title']]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $data['text_default'] = $this->language->get('text_default');
      $data['button_filter'] = $this->language->get('button_filter');
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[if ((utf8_strlen($this->request->post['name']) < 2) || (utf8_strlen($this->request->post['name']) > 128)) {]]></search>
      <add position="replace" offset="2"><![CDATA[
      // krotek_multilingual_zones
      $names = array_filter($this->request->post['name']);
      $error_name = array();
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();

      foreach ($languages as $language) {
        $name = $names[$language['language_id']];
        if (!$name || ($name && (utf8_strlen($name) < 2) || (utf8_strlen($name) > 128))) {
          $error_name[$language['language_id']] = $this->language->get('error_name');
        }
      }

      if (!empty($error_name)) $this->error['name'] = $error_name;
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function edit() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $this->model_setting_setting->checkNames('country');
      $this->load->model('localisation/language');
      $data['languages'] = $this->model_localisation_language->getLanguages();
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function getForm() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $this->model_setting_setting->checkNames('country');
      $this->load->model('localisation/language');
      $data['languages'] = $this->model_localisation_language->getLanguages();
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function getList() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $this->model_setting_setting->checkNames('country');
      $this->load->model('localisation/language');
      $data['languages'] = $this->model_localisation_language->getLanguages();

      if (isset($this->request->get['filter_name'])) {
        $filter_name = $this->request->get['filter_name'];
      } else {
        $filter_name = null;
      }

      if (isset($this->request->get['filter_iso_code_2'])) {
        $filter_iso_code_2 = $this->request->get['filter_iso_code_2'];
      } else {
        $filter_iso_code_2 = null;
      }

      if (isset($this->request->get['filter_iso_code_3'])) {
        $filter_iso_code_3 = $this->request->get['filter_iso_code_3'];
      } else {
        $filter_iso_code_3 = null;
      }

      $data['filter_name'] = $filter_name;
      $data['filter_iso_code_2'] = $filter_iso_code_2;
      $data['filter_iso_code_3'] = $filter_iso_code_3;
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$data['countries'][] = array(]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $names = $this->model_setting_setting->getItemName('country', $result['country_id']);
      $result['name'] = "";
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA['iso_code_2' => $result['iso_code_2'],]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      'name' => $names,
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$data['name'] = $country_info['name'];]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $country_info['name'] = explode('::', $country_info['name']);
      $names = array();
      foreach ($country_info['name'] as $name) {
        $name = explode('###', $name);
        $names[$name[1]] = $name[0];
      }
      $country_info['name'] = $names;
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$filter_data = array(]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      'filter_name' => $filter_name,
      'filter_iso_code_2' => $filter_iso_code_2,
      'filter_iso_code_3' => $filter_iso_code_3,
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$url .= '&sort=' . $this->request->get['sort'];]]></search>
      <add position="before" offset="1"><![CDATA[
      // krotek_multilingual_zones
      if (isset($this->request->get['filter_name'])) {
        $url .= '&filter_name='.urlencode(html_entity_decode($this->request->get['filter_name'], ENT_QUOTES, 'UTF-8'));
      }

      if (isset($this->request->get['filter_iso_code_2'])) {
        $url .= '&filter_iso_code_2=' . $this->request->get['filter_iso_code_2'];
      }

      if (isset($this->request->get['filter_iso_code_3'])) {
        $url .= '&filter_iso_code_3=' . $this->request->get['filter_iso_code_3'];
      }
      ]]></add>
    </operation>
  </file>



  <!-- Modify admin countries list -->
  <file path="admin/view/template/localisation/country_list.tpl">
    <operation>
      <search><![CDATA[<div id="content">]]></search>
      <add position="after"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <!--<link rel="stylesheet" type="text/css" href="view/stylesheet/countries_zones.css" />-->
      <script type="text/javascript" src="view/javascript/countries_zones.js"></script>
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[</thead>]]></search>
      <add position="before"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <tr class="filters">
        <td></td>
        <td><input type="text" name="filter_name" value="<?php echo $filter_name; ?>" id="input-name" class="form-control input-sm" /></td>
        <td><input type="text" name="filter_iso_code_2" value="<?php echo $filter_iso_code_2; ?>" id="input-iso-code-2" class="form-control input-sm" /></td>
        <td><input type="text" name="filter_iso_code_3" value="<?php echo $filter_iso_code_3; ?>" id="input-iso-code-3" class="form-control input-sm" /></td>
        <td><button type="button" onclick="filterItems('country');" class="btn btn-default btn-sm"><i class="fa fa-filter fa-fw"></i></button></td>
      </tr>
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[<td class="text-left"><?php echo $country['name']; ?></td>]]></search>
      <add position="replace"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <td class="text-left col-xs-4<?php echo (strpos(serialize($country['name']), '###default###') !== false ? ' default-item' : ''); ?>">
        <?php foreach ($languages as $language) { ?>
        <div class="col-xs-4">
          <div class="input-group">
            <span class="input-group-addon input-sm">
              <img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" />
            </span>
            <input type="text" id="country-<?php echo $country['country_id'].'-'.$language['language_id']; ?>" name="name[<?php echo $country['country_id']; ?>][<?php echo $language['language_id']; ?>]" value="<?php echo $country['name'][$language['language_id']]; ?>" class="form-control input-sm input-name update-name country-<?php echo $country['country_id']; ?>" />
          </div>
        </div>
        <?php } ?>
        <?php if (strpos(serialize($country['name']), "###default###") !== false) { ?>
        <span><?php echo $text_default; ?></span>
        <?php } ?>
      </td>
      ]]></add>
    </operation>
  </file>


  <!-- Modify admin country form -->
  <file path="admin/view/template/localisation/country_form.tpl">
    <operation>
      <search><![CDATA[<input type="text" name="name" value="<?php echo $name; ?>" placeholder="<?php echo $entry_name; ?>" id="input-name" class="form-control" />]]></search>
      <add position="replace" offset="3"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <?php foreach ($languages as $language) { ?>
      <div class="input-group">
        <span class="input-group-addon">
          <img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" />
        </span>
        <input type="text" name="name[<?php echo $language['language_id']; ?>]" value="<?php echo $name[$language['language_id']]; ?>" placeholder="<?php echo $entry_name; ?>" id="input-name" class="form-control" />
      </div>
      <?php if ($error_name && isset($error_name[$language['language_id']])) { ?>
      <div class="text-danger"><?php echo $error_name[$language['language_id']]; ?></div>
      <?php } ?>
      <?php } ?>
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to zones -->
  <file path="admin/model/localisation/zone.php">
    <operation>
      <search><![CDATA[function addZone($data) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      if ($data['name'] && is_array($data['name'])) {
        $newnames = array();
        foreach ($data['name'] as $language => $name) {
          $newnames[] = $name."###".$language;
        }
        $data['name'] = $this->db->escape(implode('::', $newnames));
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function editZone($zone_id, $data) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      if ($data['name'] && is_array($data['name'])) {
        $newnames = array();
        foreach ($data['name'] as $language => $name) {
          $newnames[] = $name."###".$language;
        }
        $data['name'] = $this->db->escape(implode('::', $newnames));
      }
      ]]></add>
    </operation>
    <!-- Deprecated
    <operation>
      <search><![CDATA[return $query->row;]]></search>
      <add position="before"><![CDATA[
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();

      $this->load->model('setting/setting');
      $zone = $this->model_setting_setting->getItemName('zone', $query->row['zone_id']);

      $query->row['name'] = $zone[$languages[$this->language->get('code')]['language_id']];
      ]]></add>
    </operation>
    -->
    <operation>
      <search><![CDATA[return $query->rows;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $this->load->model('setting/setting');

      foreach ($query->rows as $key => $row) {
        $zone = $this->model_setting_setting->getItemName('zone', $row['zone_id']);
        $query->rows[$key]['name'] = $zone[$languages[$this->language->get('code')]['language_id']];
        $tmp[] = $query->rows[$key]['name'];
      }

      array_multisort($tmp, $query->rows);
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $zone_data;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $this->load->model('setting/setting');

      foreach ($zone_data as $key => $row) {
        $zone = $this->model_setting_setting->getItemName('zone', $row['zone_id']);
        $zone_data[$key]['name'] = $zone[$languages[$this->language->get('code')]['language_id']];
        $tmp[] = $zone_data[$key]['name'];
      }

      array_multisort($tmp, $zone_data);
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$sort_data = array(]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $implode = array();

      if (!empty($data['filter_country'])) {
        $implode[] = "c.name LIKE '%".$this->db->escape($data['filter_country'])."%'";
      }

      if (!empty($data['filter_name'])) {
        $implode[] = "z.name LIKE '%".$this->db->escape($data['filter_name'])."%'";
      }

      if (!empty($data['filter_code'])) {
        $implode[] = "z.code LIKE '%".$this->db->escape($data['filter_code'])."%'";
      }

      if ($implode) {
        $sql .= " WHERE ".implode(" AND ", $implode);
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $query->row['total'];]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $sql = "SELECT COUNT(*) AS total FROM ".DB_PREFIX."zone AS z LEFT JOIN ".DB_PREFIX."country AS c ON (z.country_id = c.country_id)";
      $implode = array();

      if (!empty($this->request->get['filter_name'])) {
        $implode[] = "z.name LIKE '%".$this->db->escape($this->request->get['filter_name'])."%'";
      }

      if (!empty($this->request->get['filter_country'])) {
        $implode[] = "c.name LIKE '%".$this->db->escape($this->request->get['filter_country'])."%'";
      }

      if (!empty($this->request->get['filter_code'])) {
        $implode[] = "z.code LIKE '%".$this->db->escape($this->request->get['filter_code'])."%'";
      }

      if ($implode) {
        $sql .= " WHERE ".implode(" AND ", $implode);
      }

      $query = $this->db->query($sql);
      ]]></add>
    </operation>
  </file>

  <file path="admin/controller/localisation/zone.php">
    <operation>
      <search><![CDATA[$data['heading_title']]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $data['text_default'] = $this->language->get('text_default');
      $data['button_filter'] = $this->language->get('button_filter');
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[if ((utf8_strlen($this->request->post['name']) < 2) || (utf8_strlen($this->request->post['name']) > 64)) {]]></search>
      <add position="replace" offset="2"><![CDATA[
      // krotek_multilingual_zones
      $names = array_filter($this->request->post['name']);
      $error_name = array();
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();

      foreach ($languages as $language) {
        $name = $names[$language['language_id']];
        if (!$name || ($name && (utf8_strlen($name) < 2) || (utf8_strlen($name) > 64))) {
          $error_name[$language['language_id']] = $this->language->get('error_name');
        }
      }

      if (!empty($error_name)) $this->error['name'] = $error_name;
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function edit() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $this->model_setting_setting->checkNames('zone');
      $this->load->model('localisation/language');
      $data['languages'] = $this->model_localisation_language->getLanguages();
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function getForm() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $this->model_setting_setting->checkNames('zone');
      $this->load->model('localisation/language');
      $data['languages'] = $this->model_localisation_language->getLanguages();
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function getList() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('setting/setting');
      $this->model_setting_setting->checkNames('zone');
      $this->load->model('localisation/language');
      $data['languages'] = $this->model_localisation_language->getLanguages();

      if (isset($this->request->get['filter_country'])) {
        $filter_country = $this->request->get['filter_country'];
      } else {
        $filter_country = null;
      }

      if (isset($this->request->get['filter_name'])) {
        $filter_name = $this->request->get['filter_name'];
      } else {
        $filter_name = null;
      }

      if (isset($this->request->get['filter_code'])) {
        $filter_code = $this->request->get['filter_code'];
      } else {
        $filter_code = null;
      }

      $data['filter_country'] = $filter_country;
      $data['filter_name'] = $filter_name;
      $data['filter_code'] = $filter_code;
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$data['zones'][] = array(]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();

      $this->load->model('setting/setting');
      $names = $this->model_setting_setting->getItemName('zone', $result['zone_id']);

      $country = $this->model_setting_setting->getItemName('country', $result['country_id']);
      $result['country'] = $country[$languages[$this->language->get('code')]['language_id']];

      $result['name'] = "";
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA['code'    => $result['code'],]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      'name' => $names,
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$data['name'] = $zone_info['name'];]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $zone_info['name'] = explode('::', $zone_info['name']);
      $names = array();

      foreach ($zone_info['name'] as $name) {
        $name = explode('###', $name);
        $names[$name[1]] = $name[0];
      }

      $zone_info['name'] = $names;
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$filter_data = array(]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      'filter_country' => $filter_country,
      'filter_name' => $filter_name,
      'filter_code' => $filter_code,
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$url .= '&sort=' . $this->request->get['sort'];]]></search>
      <add position="before" offset="1"><![CDATA[
      // krotek_multilingual_zones
      if (isset($this->request->get['filter_country'])) {
        $url .= '&filter_country='.urlencode(html_entity_decode($this->request->get['filter_country'], ENT_QUOTES, 'UTF-8'));
      }

      if (isset($this->request->get['filter_name'])) {
        $url .= '&filter_name='.urlencode(html_entity_decode($this->request->get['filter_name'], ENT_QUOTES, 'UTF-8'));
      }

      if (isset($this->request->get['filter_code'])) {
        $url .= '&filter_code=' . $this->request->get['filter_code'];
      }
      ]]></add>
    </operation>
  </file>



  <!-- Modify admin zones list -->
  <file path="admin/view/template/localisation/zone_list.tpl">
    <operation>
      <search><![CDATA[<div id="content">]]></search>
      <add position="after"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <!--<link rel="stylesheet" type="text/css" href="view/stylesheet/countries_zones.css" />-->
      <script type="text/javascript" src="view/javascript/countries_zones.js"></script>
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[</thead>]]></search>
      <add position="before"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <tr class="filters">
        <td></td>
        <td><input type="text" name="filter_country" value="<?php echo $filter_country; ?>" id="input-country" class="form-control input-sm" /></td>
        <td><input type="text" name="filter_name" value="<?php echo $filter_name; ?>" id="input-name" class="form-control input-sm" /></td>
        <td><input type="text" name="filter_code" value="<?php echo $filter_code; ?>" id="input-code" class="form-control input-sm" /></td>
        <td><button type="button" onclick="filterItems('zone');" class="btn btn-default btn-sm"><i class="fa fa-filter fa-fw"></i></button></td>
      </tr>
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[<td class="text-left"><?php echo $zone['name']; ?></td>]]></search>
      <add position="replace"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <td class="text-left col-xs-4<?php echo (strpos(serialize($zone['name']), '###default###') !== false ? ' default-item' : ''); ?>">
        <?php foreach ($languages as $language) { ?>
        <div class="col-xs-4">
          <div class="input-group">
            <span class="input-group-addon input-sm">
              <img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" />
            </span>
            <input type="text" id="zone-<?php echo $zone['zone_id'].'-'.$language['language_id']; ?>" name="name[<?php echo $zone['zone_id']; ?>][<?php echo $language['language_id']; ?>]" value="<?php echo $zone['name'][$language['language_id']]; ?>" class="form-control input-sm input-name update-name zone-<?php echo $zone['zone_id']; ?>" />
          </div>
        </div>
        <?php } ?>
        <?php if (strpos(serialize($zone['name']), "###default###") !== false) { ?>
        <span><?php echo $text_default; ?></span>
        <?php } ?>
      </td>
      ]]></add>
    </operation>
  </file>



  <!-- Modify admin zone form -->
  <file path="admin/view/template/localisation/zone_form.tpl">
    <operation>
      <search><![CDATA[<input type="text" name="name" value="<?php echo $name; ?>" placeholder="<?php echo $entry_name; ?>" id="input-name" class="form-control" />]]></search>
      <add position="replace" offset="3"><![CDATA[
      <?php /* krotek_multilingual_zones */ ?>
      <?php foreach ($languages as $language) { ?>
      <div class="input-group">
        <span class="input-group-addon"><img src="view/image/flags/<?php echo $language['image']; ?>" title="<?php echo $language['name']; ?>" /></span>
        <input type="text" name="name[<?php echo $language['language_id']; ?>]" value="<?php echo $name[$language['language_id']]; ?>" placeholder="<?php echo $entry_name; ?>" id="input-name" class="form-control" />
      </div>
      <?php if ($error_name && isset($error_name[$language['language_id']])) { ?>
      <div class="text-danger"><?php echo $error_name[$language['language_id']]; ?></div>
      <?php } ?>
      <?php } ?>
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to admin customer -->
  <file path="admin/model/sale/customer.php">
    <operation>
      <search><![CDATA[function getAddress($address_id) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $language_id = $languages[$this->language->get('code')]['language_id'];
      $this->load->model('setting/setting');
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$country = $country_query->row['name'];]]></search>
      <add position="replace"><![CDATA[
      // krotek_multilingual_zones
      $names = $this->model_setting_setting->getItemName('country', $country_query->row['country_id']);
      $country = $names[$language_id];
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$zone = $zone_query->row['name'];]]></search>
      <add position="replace"><![CDATA[
      // krotek_multilingual_zones
      $names = $this->model_setting_setting->getItemName('zone', $zone_query->row['zone_id']);
      $zone = $names[$language_id];
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to catalog order -->
  <file path="catalog/model/checkout/order.php">
    <operation>
      <search><![CDATA[class ModelCheckoutOrder extends Model {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      public function replaceNames($data) {
        $this->load->model('setting/setting');
        if (!isset($data['language_id'])) {
          $this->load->model('localisation/language');
          $languages = $this->model_localisation_language->getLanguages();
          $data['language_id'] = $languages[$this->config->get('config_language')]['language_id'];
        }

        $names = $this->model_setting_setting->getItemName('country', $data['shipping_country_id']);
        $data['shipping_country'] = $names[$data['language_id']];

        $names = $this->model_setting_setting->getItemName('zone', $data['shipping_zone_id']);
        $data['shipping_zone'] = $names[$data['language_id']];

        $names = $this->model_setting_setting->getItemName('country', $data['payment_country_id']);
        $data['payment_country'] = $names[$data['language_id']];

        $names = $this->model_setting_setting->getItemName('zone', $data['payment_zone_id']);
        $data['payment_zone'] = $names[$data['language_id']];

        return $data;
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function addOrder($data) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $data = $this->replaceNames($data);
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function editOrder($order_id, $data) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $data = $this->replaceNames($data);
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to catalog settings -->
  <file path="catalog/model/setting/setting.php">
    <operation>
      <search><![CDATA[class ModelSettingSetting extends Model {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      public function getItemName($table, $id) {
        $query = $this->db->query("SELECT name FROM `".DB_PREFIX.$table."` WHERE ".$table."_id = '".(int)$id."'");
        $names = array();
        if (strpos($query->row['name'], '::') !== false) {
          $query->row['name'] = explode('::', $query->row['name']);
          foreach ($query->row['name'] as $name) {
            $name = explode('###', $name);
            $names[$name[1]] = $name[0];
          }
        } else {
          $this->load->model('localisation/language');
          $languages = $this->model_localisation_language->getLanguages();
          foreach ($languages as $language) {
            $names[$language['language_id']] = $query->row['name'];
          }
        }
        return $names;
      }
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to catalog countries -->
  <file path="catalog/model/localisation/country.php">
    <operation>
      <search><![CDATA[return $query->row;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      if (isset($query->row['name'])) {
        $this->load->model('localisation/language');
        $languages = $this->model_localisation_language->getLanguages();
        $this->load->model('setting/setting');

        $country = $this->model_setting_setting->getItemName('country', $country_id);
        $query->row['name'] = $country[$languages[$this->language->get('code')]['language_id']];
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $country_data;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $this->load->model('setting/setting');

      foreach ($country_data as $key => $row) {
        $country = $this->model_setting_setting->getItemName('country', $row['country_id']);
        $country_data[$key]['name'] = $country[$languages[$this->language->get('code')]['language_id']];
        $tmp[] = $country_data[$key]['name'];
      }

      array_multisort($tmp, $country_data);
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to catalog zones -->
  <file path="catalog/model/localisation/zone.php">
    <operation>
      <search><![CDATA[return $query->row;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      if (isset($query->row['name'])) {
        $this->load->model('localisation/language');
        $languages = $this->model_localisation_language->getLanguages();
        $this->load->model('setting/setting');

        $zone = $this->model_setting_setting->getItemName('zone', $zone_id);
        $query->row['name'] = $zone[$languages[$this->language->get('code')]['language_id']];
      }
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[return $zone_data;]]></search>
      <add position="before"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $this->load->model('setting/setting');

      foreach ($zone_data as $key => $row) {
        $zone = $this->model_setting_setting->getItemName('zone', $row['zone_id']);
        $zone_data[$key]['name'] = $zone[$languages[$this->language->get('code')]['language_id']];
        $tmp[] = $zone_data[$key]['name'];
      }

      // sorting handled by yym_jp_zone_sort_order
      // array_multisort($tmp, $zone_data);
      ]]></add>
    </operation>
  </file>



  <!-- Add multi language to account address -->
  <file path="catalog/model/account/address.php">
    <operation>
      <search><![CDATA[function getAddress($address_id) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $language_id = $languages[$this->language->get('code')]['language_id'];
      $this->load->model('setting/setting');
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[function getAddresses() {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->load->model('localisation/language');
      $languages = $this->model_localisation_language->getLanguages();
      $language_id = $languages[$this->language->get('code')]['language_id'];
      $this->load->model('setting/setting');
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$country = $country_query->row['name'];]]></search>
      <add position="replace"><![CDATA[
      //krotek_multilingual_zones
      $names = $this->model_setting_setting->getItemName('country', $country_query->row['country_id']);
      $country = $names[$language_id];
      ]]></add>
    </operation>
    <operation>
      <search><![CDATA[$zone = $zone_query->row['name'];]]></search>
      <add position="replace"><![CDATA[
      // krotek_multilingual_zones
      $names = $this->model_setting_setting->getItemName('zone', $zone_query->row['zone_id']);
      $zone = $names[$language_id];
      ]]></add>
    </operation>
  </file>



  <!-- Modify caching from catalog language setting -->
  <file path="catalog/controller/common/language.php">
    <operation>
      <search><![CDATA[if (isset($this->request->post['code'])) {]]></search>
      <add position="after"><![CDATA[
      // krotek_multilingual_zones
      $this->cache->delete('country');
      $this->cache->delete('zone');
      ]]></add>
    </operation>
  </file>

</modification>